
/*
Creates a view storing each simple usage numbers by day.
*/

create view [usg].[v_UsageDaily] as
select 
	DATEFROMPARTS(
		datepart(year,v.starttimestamp)
		,datepart(month,v.starttimestamp)
		,datepart(day,v.starttimestamp)
		) DateYMD
	,COUNT(*) TotalCnt
	,count(distinct UserName) UniqueTrainees
	,max(v.LaneNumber) LanesUsed
	,COUNT(distinct v.sessionlanesubjectid) DrillsRun
	,count(distinct v.sessiondetailid) DrillsRunAsGroup
	,sum(v.Shots) RoundsFired
	--to act as a foreign key 
	,YEAR(v.StartTimeStamp)*100+MONTH(v.starttimestamp) YM
	--to act as a primary key
	,YEAR(v.StartTimeStamp)*10000+MONTH(v.starttimestamp)*100+DAY(v.starttimestamp) YMD

	from v_SessionDetailLaneScore v

	group by 
	DATEFROMPARTS(
		datepart(year,v.starttimestamp)
		,datepart(month,v.starttimestamp)
		,datepart(day,v.starttimestamp)
		)
	,YEAR(v.StartTimeStamp)*100+MONTH(v.starttimestamp)
	,YEAR(v.StartTimeStamp)*10000+MONTH(v.starttimestamp)*100+DAY(v.starttimestamp)
