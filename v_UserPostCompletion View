
create view v_UserPostCompletion as

/*
This select gives a breakdown of usage by Marine and by Day
Includes only the Baseline Drills and shows a Marine's completion 
percentage of the Post Assessment.
*/

with cte1 as 
(
	select 
	post.Username,
	DATEFROMPARTS(
	datepart(year,starttimestamp)
	,datepart(month,starttimestamp)
	,datepart(day,starttimestamp)
	) DateYMD,
	--counts the total number of drill runs in the Post Assessment
	count(distinct post.SessionLaneSubjectId) BADrillsRun,
	--counts the distinct numbers of drills in the Post Assessment that were run
	count(distinct post.DrillDesc) BADistinctDrills,
	--calculates a completion percentage of the full Post Assessment
	CAST(count(distinct post.SessionLaneSubjectId) as float)
	/
	45 BACompletion,
	sum(Shots) RoundsFired

		from v_PostAssessmentSLSIDs post
		--joins to all session data from the view
		inner join v_SessionDetailLaneScore v
		on v.SessionLaneSubjectId = post.SessionLaneSubjectId
		--joins to isolate the Baseline Assessment drills
		inner join HPOBaselineDrills bd
		on v.DrillDesc = bd.Description
		--isolates Marines that correctly input EDIPI as the username as a 10-digit string
		where TRY_CAST(v.UserName as int) > 999999999
		--case: a user completed the Baseline Assessment over different days (at Lejeune)
		--and v.UserName = 1612910711

	group by 
	post.UserName,
	DATEFROMPARTS(
	datepart(year,starttimestamp)
	,datepart(month,starttimestamp)
	,datepart(day,starttimestamp))
),

cte2 as 
(
	select *
	,ROW_NUMBER() over(partition by username order by username desc, DateYMD) PostCount
	from cte1
)

select * from cte2
